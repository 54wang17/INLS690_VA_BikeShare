<html>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.css" />
<script src="./js/jquery-1.11.1.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.5/leaflet.js"></script>
<script src="http://ils.unc.edu/~gotz/courses/js/d3.v3.min.js"></script>
<script src="./js/RefineData.js"></script>
<style>
body {
font-family: Calibri;
}
#DateRange {
border: 1px solid black;
float: right;
width: 19%;
height: 680px;
}
#stationInfoSection {
height: 500px;
border: 1px solid blue;
}
#stationInfo {
border: 1px solid green;
height: 300px;
}

#map { 
height: 680px; width: 80%;

float: left;
}
select {
border-radius: 50%;
height: 25px;
width: 100px;
}

#DateQuery {
background-color: Green;
color: white;
border: 1px solid Green;
height: 25px;
width: 100px;
display: block;
margin: auto;
}
</style>
<body>
<h2> Divvy Station Rankings by Trip Volume</h2> 
<div id = "filter">
<span id="details">&nbsp;</span><br/>
<p id= 'error'></p>
<div id="DateRange">
	<form id="filterInfo">
			<label for="Rank" id="ranklabel">Show Ranking:</label> 
			<select id='Rank'>
  				<option value="top">Top 50</option>
  				<option value="bottom">Bottom 50</option>
			</select>
			<br></br>
			<label for="FlowDir" id="FlowDirlabel">Trip Direction: </label>
			<select id='FlowDir'>
				<option value="all">Both</option>
	  			<option value="in">Incoming</option>
	  			<option value="out">Outgoing</option>
			</select>
			<br></br>
			<label for="f_date" id="f_datelabel">From:    </label>
			<!-- <select class='day' id= 'f_day'></select> -->

			<select class='date' id= 'f_date'></select>
		<!-- <select class='year' id= 'f_year'></select> -->
			<br></br>
			<label for="t_date" id="t_datelabel">To: </label>
		<!-- <select class='day' id= 't_day'></select> -->
		<!-- <select class='month' id= 't_month'></select> -->
			<select class='date' id= 't_date'></select>
			<br></br>
			<button id='DateQuery'type="submit" >Submit</button>
	</form>
	<br></br>
	<div id="stationInfoSection">
		<h3>Station Information</h3>
		<p>Click on the circles to read more about the stations.</p>
		<div id="stationInfo">
			<span id="test"></span>
		</div>
	</div>
</div> 


<div id = "map"></div>
<script>

// initialize map
var map = L.map('map').setView([41.88595806,-87.62773949], 13);
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: '54wang17.cienhr5jj0dr8s2m2uf9l4qf0',
    accessToken: 'pk.eyJ1IjoiNTR3YW5nMTciLCJhIjoiY2llbmhyNXZtMGRyY3M2bTNsanRnbmRkaCJ9.fENzrbnGuc1TzxKSNBQtPQ'
}).addTo(map);

map._initPathRoot()  
var svg = d3.select("#map").select("svg"),
  	g = svg.append("g");


function renderStation(collection){

	collection.forEach(function(d) {
      d.LatLng = new L.LatLng(d.latitude,
                  d.longitude);
    })
	// console.log(collection);

	var feature = g.selectAll(".station")
	      .data(collection,function(d){return d.station_id;});
	// console.log(feature);
	var circle_normalized = d3.mean(collection,function(d){return d.inflow+d.outflow;})/6.0;
	// console.log(circle_normalized);
	feature.enter().append("circle")
	      .style("stroke", "black")  
	      .style("opacity", .6) 
	      .style("fill", "green")
	      .attr("class","station")
	      .attr("cx",function(d){return map.latLngToLayerPoint(d.LatLng).x;})
	      .attr("cy",function(d){return map.latLngToLayerPoint(d.LatLng).y;})
	      .attr("r", function(d){return ((d.inflow+d.outflow))/circle_normalized;})
	      .on("click",function(d){
	      		console.log(d.station_id);
	      		//getElementById("test").innerHTML = 
	      		//"<h4>station id</h4>";
	      		console.log("hello");
	      		document.getElementById("test").innerHTML = "<h4>"+d.name+"</h4>"+
	      		"<p>Capacity: "+d.dpcapacity+" </p>"+
	      		"<p>Number of trips to this station during time period selected: "+d.inflow+" </p>"+
	      		"<p>Number of trips from this station during time period selected: "+d.outflow+" </p>"+
	      		"<p>Average number of trips monthly during time period selected: ";    		
	     		d3.select(this).style("fill", "red");
	      }) ; 

	


	map.on("viewreset", update);
	update();

	feature.exit().remove();



	function update() {
		feature.attr("cx",function(d){return map.latLngToLayerPoint(d.LatLng).x;})
	    	.attr("cy",function(d){return map.latLngToLayerPoint(d.LatLng).y;})
	 		.attr("r", function(d){
	      		var change_ratio = map.getZoom()/6;
	      		// console.log(3*(d.inflow+d.outflow)/30000*change_ratio);
	      		return (d.inflow+d.outflow)/circle_normalized*change_ratio;}); 

	 // feature.attr("transform", 
		 //  function(d) { 
		 //  	console.log("translate("+ 
		 //      map.latLngToLayerPoint(d.LatLng).x +","+ 
		 //      map.latLngToLayerPoint(d.LatLng).y +")");
		 //    return "translate("+ 
		 //      map.latLngToLayerPoint(d.LatLng).x +","+ 
		 //      map.latLngToLayerPoint(d.LatLng).y +")";
		 //    })
	 	console.log("Zoom:" +map.getZoom());
	}
	
}

function getTrip(dir,s_id){
	$.ajax("./controller.php/trip/"+dir+"/"+s_id,
	      		{   type: "GET",
		      		 dataType: "json",
		      		 success: function(return_obj, status, jqXHR) {
		      			console.log(return_obj.length);
		      			renderTrip(return_obj);
		   		}
				});

}

function renderTrip(collection){

	console.log("renderTrip called");
	collection.forEach(function(d) {
	      d.SLatLng = new L.LatLng(d.from_latitude,
	                  d.from_longitude);
	      d.ELatLng = new L.LatLng(d.to_latitude,
	                  d.to_longitude);
	    });

	map.on("viewreset", Linkupdate);

	// console.log(g.selectAll("circle"));
	Linkupdate();

	function Linkupdate() {
		console.log("Linkupdate Called.")
	  	
	  	var inbound_trip = collection.filter(function(d){
			f_node = map.getBounds().contains(new L.LatLng(d.from_latitude, d.from_longitude));
			t_node = map.getBounds().contains(new L.LatLng(d.to_latitude, d.to_longitude));
			// console.log(f_node && t_node);
			return f_node && t_node;
		});
		console.log(inbound_trip.length);

	  	var line_link = g.selectAll("line.link")
	      				.data(inbound_trip,function(d) { return d.trip_id;});

	    line_link.enter().append("line")
	      .attr("width", 20)
	      .style("stroke","black")
	      .style("stroke-width","2px")
	      .attr("class","link")
	      .attr("x1",function(d){return map.latLngToLayerPoint(d.SLatLng).x;})
	      .attr("y1",function(d){return map.latLngToLayerPoint(d.SLatLng).y;})
	      .attr("x2",function(d){return map.latLngToLayerPoint(d.ELatLng).x;})
	      .attr("y2",function(d){return map.latLngToLayerPoint(d.ELatLng).y;});

		line_link
	      .attr("x1",function(d){return map.latLngToLayerPoint(d.SLatLng).x;})
	      .attr("y1",function(d){return map.latLngToLayerPoint(d.SLatLng).y;})
	      .attr("x2",function(d){return map.latLngToLayerPoint(d.ELatLng).x;})
	      .attr("y2",function(d){return map.latLngToLayerPoint(d.ELatLng).y;});

	   	line_link.exit().remove();
	   	
	    

	}
	
}



</script>
</body>
</html>
